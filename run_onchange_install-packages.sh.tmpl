#!/bin/bash
set -e

{{- if eq .chezmoi.os "darwin" }}
# macOS installation using Homebrew
echo "Installing packages on macOS using Homebrew..."
brew bundle --file=/dev/stdin <<EOF
{{- range .packages.darwin.brews }}
brew "{{ . }}"
{{- end }}
{{- range .packages.darwin.casks }}
cask "{{ . }}"
{{- end }}
EOF

{{- else if eq .chezmoi.os "linux" }}

# Function to detect if running in WSL
is_wsl() {
  if [ -f /proc/version ] && grep -qi microsoft /proc/version; then
    return 0  # true - running in WSL
  elif [ -f /proc/sys/kernel/osrelease ] && grep -qi microsoft /proc/sys/kernel/osrelease; then
    return 0  # true - running in WSL
  elif [ -n "${WSL_DISTRO_NAME}" ] || [ -n "${WSLENV}" ]; then
    return 0  # true - running in WSL
  else
    return 1  # false - not running in WSL
  fi
}

if [ -f /etc/arch-release ]; then
  echo "Installing packages on Arch Linux using yay..."
  if ! command -v yay &> /dev/null; then
    echo "âŒ yay is not installed. Please install yay first."
    sudo pacman -S --needed git base-devel && git clone https://aur.archlinux.org/yay.git && cd yay && makepkg -si
    exit 1
  fi
  
  # Install common packages
  echo "ğŸ“¦ Installing common Arch Linux packages..."
  yay -S --noconfirm {{ range .packages.arch.packages }}"{{ . }}" {{ end }}
  
  # Check if we're in WSL and install non-WSL packages accordingly
  if is_wsl; then
    echo "ğŸ§ WSL detected - skipping GUI applications and games"
  else
    echo "ğŸ–¥ï¸  Native Linux detected - installing GUI applications and games..."
    yay -S --noconfirm {{ range .packages.arch.non_wsl_packages }}"{{ . }}" {{ end }}
  fi

elif [ -f /etc/debian_version ]; then
  echo "Installing packages on Ubuntu/Debian using apt..."
  sudo apt update
  sudo apt install -y {{ range .packages.ubuntu.packages }}"{{ . }}" {{ end }}

fi


{{- end }}

