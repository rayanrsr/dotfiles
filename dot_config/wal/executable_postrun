#!/usr/bin/env bash

# Pywal post-run hook
# This script runs after pywal generates colors
# It applies the generated colors to waybar and ulauncher

set -e

# Colors are generated in ~/.cache/wal/

# 1. Apply waybar colors
if [ -f "$HOME/.cache/wal/colors-waybar.css" ]; then
    mkdir -p "$HOME/.config/waybar"
    cp "$HOME/.cache/wal/colors-waybar.css" "$HOME/.config/waybar/style.css"
    
    # Reload waybar if running
    if pgrep -x waybar > /dev/null; then
        killall waybar
        waybar &
    fi
fi

# 2. Apply ulauncher colors
if [ -f "$HOME/.cache/wal/colors-ulauncher.css" ]; then
    ULAUNCHER_THEME_DIR="$HOME/.config/ulauncher/user-themes/pywal"
    mkdir -p "$ULAUNCHER_THEME_DIR"
    
    # Copy generated colors
    cp "$HOME/.cache/wal/colors-ulauncher.css" "$ULAUNCHER_THEME_DIR/generated.css"
    
    # Create manifest if it doesn't exist
    if [ ! -f "$ULAUNCHER_THEME_DIR/manifest.json" ]; then
        cat > "$ULAUNCHER_THEME_DIR/manifest.json" <<EOF
{
  "manifest_version": "1",
  "name": "Pywal",
  "display_name": "Pywal Dynamic Colors",
  "extend_theme": "light",
  "css_file": "generated.css",
  "css_file_gtk_3.20+": "generated.css",
  "matched_text_hl_colors": {
    "when_selected": "#000000",
    "when_not_selected": "#000000"
  }
}
EOF
    fi
    
    # Create base theme.css if it doesn't exist
    if [ ! -f "$ULAUNCHER_THEME_DIR/theme.css" ]; then
        cat > "$ULAUNCHER_THEME_DIR/theme.css" <<EOF
/* Base theme for pywal ulauncher */
.app {{
    border-radius: 12px;
}}

.input {{
    border-radius: 8px;
    padding: 12px;
    font-size: 16px;
    margin: 8px;
}}

.item-box {{
    padding: 8px 12px;
    margin: 2px 8px;
    border-radius: 6px;
    transition: all 0.15s ease;
}}

.item-name {{
    font-size: 14px;
    font-weight: 600;
}}

.item-text {{
    font-size: 12px;
}}
EOF
    fi
    
    # Update ulauncher settings to use pywal theme
    ULAUNCHER_SETTINGS="$HOME/.config/ulauncher/settings.json"
    if [ -f "$ULAUNCHER_SETTINGS" ]; then
        # Use jq if available, otherwise use sed
        if command -v jq &> /dev/null; then
            TMP=$(mktemp)
            jq '.["theme-name"] = "pywal"' "$ULAUNCHER_SETTINGS" > "$TMP"
            mv "$TMP" "$ULAUNCHER_SETTINGS"
        else
            sed -i 's/"theme-name": "[^"]*"/"theme-name": "pywal"/' "$ULAUNCHER_SETTINGS"
        fi
    fi
    
    # Restart ulauncher if running
    if pgrep -x ulauncher > /dev/null; then
        killall ulauncher
        ulauncher --hide-window &
    fi
fi

# 3. Reload swaync with pywal colors (optional)
if [ -f "$HOME/.cache/wal/colors.sh" ]; then
    # Reload swaync to pick up new colors if you want
    if pgrep -x swaync > /dev/null; then
        swaync-client -rs > /dev/null 2>&1 || true
    fi
fi

# 4. Send notification
if command -v notify-send &> /dev/null; then
    notify-send "Pywal" "Color scheme updated" -t 2000 -u low
fi

